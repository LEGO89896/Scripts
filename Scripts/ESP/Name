local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera
local EspName = "EN"

local CharacterConnections = {}
local NewPlayers = {}
local PlayerAddedConnection = nil
local RunEspName = {}

function CreateEspName(player, Color)
	if not player.Character then return end
	local head = player.Character:FindFirstChild("Head")
	if head and not head:FindFirstChild(EspName) then
		local BillboardGui = Instance.new("BillboardGui")
		BillboardGui.Size = UDim2.new(0, 100, 0, 20)
		BillboardGui.Adornee = head
		BillboardGui.AlwaysOnTop = true
		BillboardGui.Name = EspName
		BillboardGui.Parent = head

		local Name = Instance.new("TextLabel")
		Name.Size = UDim2.new(1, 0, 1, 0)
		Name.BackgroundTransparency = 1
		Name.TextColor3 = Color
		Name.TextStrokeTransparency = 0.5
		Name.TextStrokeColor3 = Color3.new(0, 0, 0)
		Name.Text = player.Name
		Name.Font = Enum.Font.SourceSansBold
		Name.TextSize = 14
		Name.TextScaled = true
		Name.Parent = BillboardGui
	end
end

function RunEspName:On(Color)
	for _, player in pairs(Players:GetPlayers()) do
		if player ~= LocalPlayer then
			CreateEspName(player, Color)

			if CharacterConnections[player] then
				CharacterConnections[player]:Disconnect()
			end

			CharacterConnections[player] = player.CharacterAdded:Connect(function()
				task.wait(1)
				CreateEspName(player, Color)
			end)
		end
	end

	PlayerAddedConnection = Players.PlayerAdded:Connect(function(plr)
		NewPlayers[plr] = plr.CharacterAdded:Connect(function()
			task.wait(1)
			CreateEspName(plr, Color)
		end)
	end)
end

function RunEspName:Off()
	for _, player in pairs(Players:GetPlayers()) do
		local character = player.Character
		if character and character:FindFirstChild("Head") then
			local head = character.Head
			local esp = head:FindFirstChild(EspName)
			if esp then
				esp:Destroy()
			end
		end

		if CharacterConnections[player] then
			CharacterConnections[player]:Disconnect()
			CharacterConnections[player] = nil
		end
	end

	for plr, conn in pairs(NewPlayers) do
		if conn then
			conn:Disconnect()
		end
		NewPlayers[plr] = nil
	end

	if PlayerAddedConnection then
		PlayerAddedConnection:Disconnect()
		PlayerAddedConnection = nil
	end
end

return RunEspName
